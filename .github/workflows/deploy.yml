name: Deploy Flask to Dokploy

on:
  push:
    branches: [main]

env:
  APP_NAME: "my-flask-app"  # è¯·æ›´æ”¹ä¸ºä½ çš„åº”ç”¨åç§°ï¼ˆä»…å°å†™å­—æ¯ã€æ•°å­—å’ŒçŸ­æ¨ªçº¿ï¼‰
  DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}  # ä»GitHub Secretsè·å–

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - uses: actions/checkout@v4

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          # å¦‚æœæœ‰æµ‹è¯•å¯ä»¥æ·»åŠ ï¼š
          # pytest tests/

      # 4. é…ç½®Dockeræ„å»ºç¯å¢ƒ
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: "docker-container"

      # 5. ç™»å½•Docker Hub
      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6. æ„å»ºå¹¶æ¨é€é•œåƒï¼ˆç®€åŒ–ç‰ˆï¼Œæ— ç¼“å­˜ï¼‰
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_USER }}/${{ env.APP_NAME }}:latest
            ${{ env.DOCKER_USER }}/${{ env.APP_NAME }}:${{ github.sha }}

      # 7. è§¦å‘Dokployéƒ¨ç½²
      - name: Deploy to Dokploy
        run: |
          DEPLOY_IMAGE="${{ env.DOCKER_USER }}/${{ env.APP_NAME }}:${{ github.sha }}"
          echo "ğŸ›« æ­£åœ¨éƒ¨ç½²é•œåƒ: $DEPLOY_IMAGE"
          
          curl -X POST "${{ secrets.DOKPLOY_SERVER_URL }}/api/applications/${{ secrets.DOKPLOY_APP_ID }}/deploy" \
            -H "Authorization: Bearer ${{ secrets.DOKPLOY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"image": "'"$DEPLOY_IMAGE"'"}'

          echo "âœ… éƒ¨ç½²è¯·æ±‚å·²å‘é€"

      # 8. å¥åº·æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Verify Deployment
        if: success()
        run: |
          echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨ï¼ˆ30ç§’ï¼‰..."
          sleep 30
          echo "ğŸ” æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€:"
          curl -sSf ${{ secrets.APP_URL }}/health || echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"